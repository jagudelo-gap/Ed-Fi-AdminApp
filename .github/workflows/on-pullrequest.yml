name: On Pull Request

on:
  push:
    branches:
      - 'main'
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:

# Adopt standard concurrency pattern
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Set broad read permissions; job-level security-events added where needed
permissions: read-all

jobs:
  scan-actions-bidi:
    name: Scan Actions, scan all files for BIDI Trojan Attacks
    uses: ed-fi-alliance-oss/ed-fi-actions/.github/workflows/repository-scanner.yml@main
    with:
      config-file-path: ./.github/workflows/bidi-config.json

  setup:
    name: Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Node (from .nvmrc)
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies (ci)
        run: npm ci --legacy-peer-deps

  code_analysis:
    name: Code Analysis (CodeQL & Dependency Review)
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Dependency Review
        uses: actions/dependency-review-action@9129d7d40b8c12c1ed0f60400d00c92d437adcce # v4.1.3

      - name: Setup Node
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Initialize CodeQL
        uses: github/codeql-action/init@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        with:
          languages: typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0

  lint:
    name: Prettier Check
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Node (from .nvmrc)
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies (ci)
        run: npm ci --legacy-peer-deps

      - name: Fix Prettier issues
        run: npm run prettier:write

      - name: Verify Prettier formatting
        run: npm run prettier:check

  build_and_test:
    name: Build & Test (${{ matrix.package }})
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [fe, be, models-server, utils]
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Node (from .nvmrc)
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies (ci)
        run: npm ci --legacy-peer-deps

      - name: Determine actual Nx project name
        id: proj
        run: |
          if [ "${{ matrix.package }}" = "be" ]; then echo "actual=api" >> $GITHUB_OUTPUT; else echo "actual=${{ matrix.package }}" >> $GITHUB_OUTPUT; fi

      - name: Build (if build target exists)
        run: |
          ACTUAL="${{ steps.proj.outputs.actual }}"
          if npm run | grep -q "build:${ACTUAL}"; then
            npm run build:${ACTUAL}
          elif npx nx show project "$ACTUAL" 2>/dev/null | grep -q "targets:.*build"; then
            npx nx run $ACTUAL:build
          else
            echo "No build step for $ACTUAL; skipping build."
          fi

      - name: Test
        run: |
          ACTUAL="${{ steps.proj.outputs.actual }}"
          echo "Running tests for $ACTUAL"
          npm run test:$ACTUAL

  docker_analysis:
    name: Docker Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [fe, api]
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Hadolint
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: packages/${{ matrix.package }}/Dockerfile
          failure-threshold: error

      - name: Docker Build
        run: docker build -t adminapp-${{ matrix.package }}-ci -f packages/${{ matrix.package }}/Dockerfile .